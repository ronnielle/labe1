
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labe - Astrocartography</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.4s ease-in;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo {
            font-size: 3rem;
            font-weight: 200;
            letter-spacing: 8px;
            margin-bottom: 1rem;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .logo:hover {
            opacity: 0.7;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #999;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
        }
        
        input {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #fff;
        }
        
        input::placeholder {
            color: #555;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid #333;
            border-top: none;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-suggestions.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #222;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #1a1a1a;
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            background: #fff;
            color: #000;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            margin-top: 2rem;
        }
        
        .btn:hover {
            background: #ddd;
        }
        
        .categories {
            display: grid;
            gap: 1rem;
            max-width: 500px;
        }
        
        .category-card {
            padding: 2rem;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .category-card:hover {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .category-card h3 {
            font-size: 1.25rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }
        
        .category-card p {
            font-size: 0.875rem;
            color: #999;
        }
        
        .map-container {
            border: 1px solid #333;
            padding: 1rem;
            background: #000;
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #mapCanvas {
            width: 100%;
            min-width: 800px;
            height: 600px;
            display: block;
        }
        
        @media (min-width: 768px) {
            .map-container {
                padding: 2rem;
            }
            
            #mapCanvas {
                min-width: 100%;
                height: 900px;
            }
        }
        
        .back-btn {
            background: transparent;
            color: #fff;
            border: 1px solid #333;
            margin-top: 1rem;
        }
        
        .back-btn:hover {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .map-info {
            margin-top: 2rem;
            padding: 1.5rem;
            border: 1px solid #333;
        }
        
        .map-info h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            color: #999;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .legend-line {
            width: 30px;
            height: 2px;
        }
        
        .error {
            color: #ff6b6b;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .city-list {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #222;
        }
        
        .city-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .city-name {
            font-weight: 500;
            font-size: 1rem;
        }
        
        .city-country {
            font-size: 0.875rem;
            color: #999;
            margin-top: 0.25rem;
        }
        
        .city-lines {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #fff;
        }
        
        .tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }
        
        #chartCanvas {
            border: 1px solid #333;
        }
        
        .chart-info {
            width: 100%;
            max-width: 600px;
        }
        
        .planet-position {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #222;
        }
        
        .planet-symbol {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        
        .planet-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .planet-sign {
            font-size: 0.875rem;
            color: #999;
        }
        
        .planet-degree {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .logo {
                font-size: 2rem;
                letter-spacing: 4px;
                margin-bottom: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            input {
                padding: 0.875rem;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .btn {
                padding: 0.875rem;
                font-size: 0.95rem;
            }
            
            .category-card {
                padding: 1.5rem;
            }
            
            .category-card h3 {
                font-size: 1.1rem;
            }
            
            .category-card p {
                font-size: 0.8rem;
            }
            
            .legend {
                gap: 1rem;
            }
            
            .legend-item {
                font-size: 0.8rem;
            }
            
            .city-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .city-lines {
                font-size: 0.7rem;
            }
            
            .map-info {
                padding: 1rem;
            }
            
            .tab-navigation {
                gap: 0.5rem;
                overflow-x: auto;
            }
            
            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
            }
            
            #chartCanvas {
                width: 100%;
                height: auto;
            }
            
            .planet-position {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Screen 1: Birth Details -->
        <div class="screen active" id="screen1">
            <div class="logo" onclick="goToHomepage()">LABE</div>
            <h1>Your cosmic map awaits</h1>
            <p class="subtitle">Discover where in the world your potential truly shines. We'll map your birth chart across the globe to reveal the places that amplify different aspects of your life.</p>
            
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="userName" placeholder="What should we call you?" required>
                <div class="error" id="nameError"></div>
            </div>
            
            <div class="input-group">
                <label>Birth Date</label>
                <input type="date" id="birthDate" required>
                <div class="error" id="dateError"></div>
            </div>
            <div class="input-group">
                <label>Birth Time</label>
                <input type="time" id="birthTime" required>
                <div class="error" id="timeError"></div>
            </div>
            <div class="input-group">
                <label>Birth Location</label>
                <input type="text" id="birthLocation" placeholder="Start typing your birth city..." required autocomplete="off">
                <div class="autocomplete-suggestions" id="suggestions"></div>
                <div class="error" id="locationError"></div>
            </div>
            <button class="btn" onclick="validateAndContinue()">Continue</button>
        </div>
        
        <!-- Screen 2: Category Selection -->
        <div class="screen" id="screen2">
            <div class="logo" onclick="goToHomepage()">LABE</div>
            <h2 id="greetingText">Hi there,</h2>
            <p class="subtitle">Choose what matters most to you right now. We'll show you the places around the world where this energy flows strongest for you.</p>
            <div class="categories">
                <div class="category-card" onclick="calculateMap('career')">
                    <h3>Career Advancement</h3>
                    <p>Where your ambition finds fertile ground</p>
                </div>
                <div class="category-card" onclick="calculateMap('studies')">
                    <h3>Studies & Learning</h3>
                    <p>Where knowledge opens doors</p>
                </div>
                <div class="category-card" onclick="calculateMap('love')">
                    <h3>Love & Romance</h3>
                    <p>Where hearts align</p>
                </div>
                <div class="category-card" onclick="calculateMap('family')">
                    <h3>Family & Home</h3>
                    <p>Where you belong</p>
                </div>
            </div>
            <button class="btn back-btn" onclick="nextScreen(1)">Back</button>
        </div>
        
        <!-- Screen 3: Map View -->
        <div class="screen" id="screen3">
            <div class="logo" onclick="goToHomepage()">LABE</div>
            <h2 id="selectedCategory">Your Map</h2>
            <p class="subtitle" id="mapSubtitle"></p>
            
            <div class="tab-navigation">
                <button class="tab active" onclick="switchTab('map')">Astrocartography Map</button>
                <button class="tab" onclick="switchTab('chart')">Natal Chart</button>
            </div>
            
            <div id="mapView">
                <div class="map-container">
                    <canvas id="mapCanvas"></canvas>
                </div>
                <div class="map-info">
                    <h3>Your Planetary Lines</h3>
                    <div class="legend" id="legend"></div>
                    <div id="interpretations"></div>
                    <div class="city-list" id="cityList"></div>
                </div>
            </div>
            
            <div id="chartView" style="display: none;">
                <div class="chart-container">
                    <canvas id="chartCanvas" width="500" height="500"></canvas>
                    <div class="chart-info">
                        <h3 style="font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; color: #999;">Your Planetary Positions</h3>
                        <div id="planetPositions"></div>
                    </div>
                </div>
            </div>
            
            <button class="btn back-btn" onclick="nextScreen(2)">Explore Another Path</button>
        </div>
    </div>
    
    <script>
        const worldCities = [
            // United States - Major & Minor
            { name: 'New York', country: 'United States', lat: 40.7128, lon: -74.0060 },
            { name: 'Los Angeles', country: 'United States', lat: 34.0522, lon: -118.2437 },
            { name: 'Chicago', country: 'United States', lat: 41.8781, lon: -87.6298 },
            { name: 'Houston', country: 'United States', lat: 29.7604, lon: -95.3698 },
            { name: 'Phoenix', country: 'United States', lat: 33.4484, lon: -112.0740 },
            { name: 'Philadelphia', country: 'United States', lat: 39.9526, lon: -75.1652 },
            { name: 'San Antonio', country: 'United States', lat: 29.4241, lon: -98.4936 },
            { name: 'San Diego', country: 'United States', lat: 32.7157, lon: -117.1611 },
            { name: 'Dallas', country: 'United States', lat: 32.7767, lon: -96.7970 },
            { name: 'San Jose', country: 'United States', lat: 37.3382, lon: -121.8863 },
            { name: 'Austin', country: 'United States', lat: 30.2672, lon: -97.7431 },
            { name: 'San Francisco', country: 'United States', lat: 37.7749, lon: -122.4194 },
            { name: 'Seattle', country: 'United States', lat: 47.6062, lon: -122.3321 },
            { name: 'Denver', country: 'United States', lat: 39.7392, lon: -104.9903 },
            { name: 'Washington DC', country: 'United States', lat: 38.9072, lon: -77.0369 },
            { name: 'Boston', country: 'United States', lat: 42.3601, lon: -71.0589 },
            { name: 'Nashville', country: 'United States', lat: 36.1627, lon: -86.7816 },
            { name: 'Portland', country: 'United States', lat: 45.5152, lon: -122.6784 },
            { name: 'Las Vegas', country: 'United States', lat: 36.1699, lon: -115.1398 },
            { name: 'Miami', country: 'United States', lat: 25.7617, lon: -80.1918 },
            { name: 'Atlanta', country: 'United States', lat: 33.7490, lon: -84.3880 },
            { name: 'Detroit', country: 'United States', lat: 42.3314, lon: -83.0458 },
            { name: 'Minneapolis', country: 'United States', lat: 44.9778, lon: -93.2650 },
            { name: 'Tampa', country: 'United States', lat: 27.9506, lon: -82.4572 },
            { name: 'Orlando', country: 'United States', lat: 28.5383, lon: -81.3792 },
            { name: 'Charlotte', country: 'United States', lat: 35.2271, lon: -80.8431 },
            { name: 'Salt Lake City', country: 'United States', lat: 40.7608, lon: -111.8910 },
            { name: 'Honolulu', country: 'United States', lat: 21.3099, lon: -157.8581 },
            { name: 'Anchorage', country: 'United States', lat: 61.2181, lon: -149.9003 },
            
            // Canada
            { name: 'Toronto', country: 'Canada', lat: 43.6532, lon: -79.3832 },
            { name: 'Montreal', country: 'Canada', lat: 45.5017, lon: -73.5673 },
            { name: 'Vancouver', country: 'Canada', lat: 49.2827, lon: -123.1207 },
            { name: 'Calgary', country: 'Canada', lat: 51.0447, lon: -114.0719 },
            { name: 'Edmonton', country: 'Canada', lat: 53.5461, lon: -113.4938 },
            { name: 'Ottawa', country: 'Canada', lat: 45.4215, lon: -75.6972 },
            { name: 'Quebec City', country: 'Canada', lat: 46.8139, lon: -71.2080 },
            { name: 'Winnipeg', country: 'Canada', lat: 49.8951, lon: -97.1384 },
            { name: 'Halifax', country: 'Canada', lat: 44.6488, lon: -63.5752 },
            { name: 'Victoria', country: 'Canada', lat: 48.4284, lon: -123.3656 },
            
            // Mexico & Central America
            { name: 'Mexico City', country: 'Mexico', lat: 19.4326, lon: -99.1332 },
            { name: 'Guadalajara', country: 'Mexico', lat: 20.6597, lon: -103.3496 },
            { name: 'Monterrey', country: 'Mexico', lat: 25.6866, lon: -100.3161 },
            { name: 'Cancun', country: 'Mexico', lat: 21.1619, lon: -86.8515 },
            { name: 'Tijuana', country: 'Mexico', lat: 32.5149, lon: -117.0382 },
            { name: 'Playa del Carmen', country: 'Mexico', lat: 20.6296, lon: -87.0739 },
            { name: 'Puerto Vallarta', country: 'Mexico', lat: 20.6534, lon: -105.2253 },
            { name: 'Guatemala City', country: 'Guatemala', lat: 14.6349, lon: -90.5069 },
            { name: 'San Jose', country: 'Costa Rica', lat: 9.9281, lon: -84.0907 },
            { name: 'Panama City', country: 'Panama', lat: 8.9824, lon: -79.5199 },
            
            // South America
            { name: 'Sao Paulo', country: 'Brazil', lat: -23.5505, lon: -46.6333 },
            { name: 'Rio de Janeiro', country: 'Brazil', lat: -22.9068, lon: -43.1729 },
            { name: 'Brasilia', country: 'Brazil', lat: -15.8267, lon: -47.9218 },
            { name: 'Salvador', country: 'Brazil', lat: -12.9714, lon: -38.5014 },
            { name: 'Fortaleza', country: 'Brazil', lat: -3.7172, lon: -38.5433 },
            { name: 'Recife', country: 'Brazil', lat: -8.0476, lon: -34.8770 },
            { name: 'Manaus', country: 'Brazil', lat: -3.1190, lon: -60.0217 },
            { name: 'Curitiba', country: 'Brazil', lat: -25.4284, lon: -49.2733 },
            { name: 'Buenos Aires', country: 'Argentina', lat: -34.6037, lon: -58.3816 },
            { name: 'Cordoba', country: 'Argentina', lat: -31.4201, lon: -64.1888 },
            { name: 'Rosario', country: 'Argentina', lat: -32.9442, lon: -60.6505 },
            { name: 'Mendoza', country: 'Argentina', lat: -32.8895, lon: -68.8458 },
            { name: 'Santiago', country: 'Chile', lat: -33.4489, lon: -70.6693 },
            { name: 'Valparaiso', country: 'Chile', lat: -33.0472, lon: -71.6127 },
            { name: 'Lima', country: 'Peru', lat: -12.0464, lon: -77.0428 },
            { name: 'Cusco', country: 'Peru', lat: -13.5319, lon: -71.9675 },
            { name: 'Bogota', country: 'Colombia', lat: 4.7110, lon: -74.0721 },
            { name: 'Medellin', country: 'Colombia', lat: 6.2442, lon: -75.5812 },
            { name: 'Cartagena', country: 'Colombia', lat: 10.3910, lon: -75.4794 },
            { name: 'Quito', country: 'Ecuador', lat: -0.1807, lon: -78.4678 },
            { name: 'Guayaquil', country: 'Ecuador', lat: -2.1709, lon: -79.9224 },
            { name: 'Caracas', country: 'Venezuela', lat: 10.4806, lon: -66.9036 },
            { name: 'La Paz', country: 'Bolivia', lat: -16.5000, lon: -68.1500 },
            { name: 'Montevideo', country: 'Uruguay', lat: -34.9011, lon: -56.1645 },
            
            // Europe - Western
            { name: 'London', country: 'United Kingdom', lat: 51.5074, lon: -0.1278 },
            { name: 'Manchester', country: 'United Kingdom', lat: 53.4808, lon: -2.2426 },
            { name: 'Edinburgh', country: 'United Kingdom', lat: 55.9533, lon: -3.1883 },
            { name: 'Dublin', country: 'Ireland', lat: 53.3498, lon: -6.2603 },
            { name: 'Paris', country: 'France', lat: 48.8566, lon: 2.3522 },
            { name: 'Lyon', country: 'France', lat: 45.7640, lon: 4.8357 },
            { name: 'Marseille', country: 'France', lat: 43.2965, lon: 5.3698 },
            { name: 'Nice', country: 'France', lat: 43.7102, lon: 7.2620 },
            { name: 'Bordeaux', country: 'France', lat: 44.8378, lon: -0.5792 },
            { name: 'Berlin', country: 'Germany', lat: 52.5200, lon: 13.4050 },
            { name: 'Munich', country: 'Germany', lat: 48.1351, lon: 11.5820 },
            { name: 'Hamburg', country: 'Germany', lat: 53.5511, lon: 9.9937 },
            { name: 'Frankfurt', country: 'Germany', lat: 50.1109, lon: 8.6821 },
            { name: 'Cologne', country: 'Germany', lat: 50.9375, lon: 6.9603 },
            { name: 'Madrid', country: 'Spain', lat: 40.4168, lon: -3.7038 },
            { name: 'Barcelona', country: 'Spain', lat: 41.3851, lon: 2.1734 },
            { name: 'Valencia', country: 'Spain', lat: 39.4699, lon: -0.3763 },
            { name: 'Seville', country: 'Spain', lat: 37.3891, lon: -5.9845 },
            { name: 'Malaga', country: 'Spain', lat: 36.7213, lon: -4.4214 },
            { name: 'Ibiza', country: 'Spain', lat: 38.9067, lon: 1.4206 },
            { name: 'Rome', country: 'Italy', lat: 41.9028, lon: 12.4964 },
            { name: 'Milan', country: 'Italy', lat: 45.4642, lon: 9.1900 },
            { name: 'Venice', country: 'Italy', lat: 45.4408, lon: 12.3155 },
            { name: 'Florence', country: 'Italy', lat: 43.7696, lon: 11.2558 },
            { name: 'Naples', country: 'Italy', lat: 40.8518, lon: 14.2681 },
            { name: 'Amsterdam', country: 'Netherlands', lat: 52.3676, lon: 4.9041 },
            { name: 'Rotterdam', country: 'Netherlands', lat: 51.9225, lon: 4.4792 },
            { name: 'Brussels', country: 'Belgium', lat: 50.8503, lon: 4.3517 },
            { name: 'Antwerp', country: 'Belgium', lat: 51.2194, lon: 4.4025 },
            { name: 'Zurich', country: 'Switzerland', lat: 47.3769, lon: 8.5417 },
            { name: 'Geneva', country: 'Switzerland', lat: 46.2044, lon: 6.1432 },
            { name: 'Vienna', country: 'Austria', lat: 48.2082, lon: 16.3738 },
            { name: 'Salzburg', country: 'Austria', lat: 47.8095, lon: 13.0550 },
            { name: 'Lisbon', country: 'Portugal', lat: 38.7223, lon: -9.1393 },
            { name: 'Porto', country: 'Portugal', lat: 41.1579, lon: -8.6291 },
            
            // Europe - Northern
            { name: 'Stockholm', country: 'Sweden', lat: 59.3293, lon: 18.0686 },
            { name: 'Gothenburg', country: 'Sweden', lat: 57.7089, lon: 11.9746 },
            { name: 'Oslo', country: 'Norway', lat: 59.9139, lon: 10.7522 },
            { name: 'Bergen', country: 'Norway', lat: 60.3913, lon: 5.3221 },
            { name: 'Copenhagen', country: 'Denmark', lat: 55.6761, lon: 12.5683 },
            { name: 'Helsinki', country: 'Finland', lat: 60.1699, lon: 24.9384 },
            { name: 'Reykjavik', country: 'Iceland', lat: 64.1466, lon: -21.9426 },
            
            // Europe - Eastern
            { name: 'Moscow', country: 'Russia', lat: 55.7558, lon: 37.6173 },
            { name: 'St Petersburg', country: 'Russia', lat: 59.9343, lon: 30.3351 },
            { name: 'Warsaw', country: 'Poland', lat: 52.2297, lon: 21.0122 },
            { name: 'Krakow', country: 'Poland', lat: 50.0647, lon: 19.9450 },
            { name: 'Prague', country: 'Czech Republic', lat: 50.0755, lon: 14.4378 },
            { name: 'Budapest', country: 'Hungary', lat: 47.4979, lon: 19.0402 },
            { name: 'Bucharest', country: 'Romania', lat: 44.4268, lon: 26.1025 },
            { name: 'Athens', country: 'Greece', lat: 37.9838, lon: 23.7275 },
            { name: 'Santorini', country: 'Greece', lat: 36.3932, lon: 25.4615 },
            { name: 'Mykonos', country: 'Greece', lat: 37.4467, lon: 25.3289 },
            { name: 'Istanbul', country: 'Turkey', lat: 41.0082, lon: 28.9784 },
            { name: 'Ankara', country: 'Turkey', lat: 39.9334, lon: 32.8597 },
            { name: 'Antalya', country: 'Turkey', lat: 36.8969, lon: 30.7133 },
            
            // Middle East
            { name: 'Dubai', country: 'UAE', lat: 25.2048, lon: 55.2708 },
            { name: 'Abu Dhabi', country: 'UAE', lat: 24.4539, lon: 54.3773 },
            { name: 'Doha', country: 'Qatar', lat: 25.2854, lon: 51.5310 },
            { name: 'Riyadh', country: 'Saudi Arabia', lat: 24.7136, lon: 46.6753 },
            { name: 'Jeddah', country: 'Saudi Arabia', lat: 21.5433, lon: 39.1728 },
            { name: 'Tel Aviv', country: 'Israel', lat: 32.0853, lon: 34.7818 },
            { name: 'Jerusalem', country: 'Israel', lat: 31.7683, lon: 35.2137 },
            { name: 'Beirut', country: 'Lebanon', lat: 33.8938, lon: 35.5018 },
            { name: 'Amman', country: 'Jordan', lat: 31.9454, lon: 35.9284 },
            { name: 'Tehran', country: 'Iran', lat: 35.6892, lon: 51.3890 },
            
            // Africa
            { name: 'Cairo', country: 'Egypt', lat: 30.0444, lon: 31.2357 },
            { name: 'Alexandria', country: 'Egypt', lat: 31.2001, lon: 29.9187 },
            { name: 'Marrakech', country: 'Morocco', lat: 31.6295, lon: -7.9811 },
            { name: 'Casablanca', country: 'Morocco', lat: 33.5731, lon: -7.5898 },
            { name: 'Cape Town', country: 'South Africa', lat: -33.9249, lon: 18.4241 },
            { name: 'Johannesburg', country: 'South Africa', lat: -26.2041, lon: 28.0473 },
            { name: 'Durban', country: 'South Africa', lat: -29.8587, lon: 31.0218 },
            { name: 'Nairobi', country: 'Kenya', lat: -1.2921, lon: 36.8219 },
            { name: 'Lagos', country: 'Nigeria', lat: 6.5244, lon: 3.3792 },
            { name: 'Accra', country: 'Ghana', lat: 5.6037, lon: -0.1870 },
            { name: 'Addis Ababa', country: 'Ethiopia', lat: 9.0320, lon: 38.7469 },
            { name: 'Tunis', country: 'Tunisia', lat: 36.8065, lon: 10.1815 },
            
            // Asia - East
            { name: 'Beijing', country: 'China', lat: 39.9042, lon: 116.4074 },
            { name: 'Shanghai', country: 'China', lat: 31.2304, lon: 121.4737 },
            { name: 'Hong Kong', country: 'China', lat: 22.3193, lon: 114.1694 },
            { name: 'Shenzhen', country: 'China', lat: 22.5431, lon: 114.0579 },
            { name: 'Guangzhou', country: 'China', lat: 23.1291, lon: 113.2644 },
            { name: 'Chengdu', country: 'China', lat: 30.5728, lon: 104.0668 },
            { name: 'Tokyo', country: 'Japan', lat: 35.6762, lon: 139.6503 },
            { name: 'Osaka', country: 'Japan', lat: 34.6937, lon: 135.5023 },
            { name: 'Kyoto', country: 'Japan', lat: 35.0116, lon: 135.7681 },
            { name: 'Hiroshima', country: 'Japan', lat: 34.3853, lon: 132.4553 },
            { name: 'Sapporo', country: 'Japan', lat: 43.0642, lon: 141.3469 },
            { name: 'Seoul', country: 'South Korea', lat: 37.5665, lon: 126.9780 },
            { name: 'Busan', country: 'South Korea', lat: 35.1796, lon: 129.0756 },
            { name: 'Jeju', country: 'South Korea', lat: 33.4996, lon: 126.5312 },
            { name: 'Taipei', country: 'Taiwan', lat: 25.0330, lon: 121.5654 },
            
            // Asia - South & Southeast
            { name: 'Mumbai', country: 'India', lat: 19.0760, lon: 72.8777 },
            { name: 'Delhi', country: 'India', lat: 28.7041, lon: 77.1025 },
            { name: 'Bangalore', country: 'India', lat: 12.9716, lon: 77.5946 },
            { name: 'Chennai', country: 'India', lat: 13.0827, lon: 80.2707 },
            { name: 'Kolkata', country: 'India', lat: 22.5726, lon: 88.3639 },
            { name: 'Jaipur', country: 'India', lat: 26.9124, lon: 75.7873 },
            { name: 'Goa', country: 'India', lat: 15.2993, lon: 74.1240 },
            { name: 'Bangkok', country: 'Thailand', lat: 13.7563, lon: 100.5018 },
            { name: 'Phuket', country: 'Thailand', lat: 7.8804, lon: 98.3923 },
            { name: 'Chiang Mai', country: 'Thailand', lat: 18.7883, lon: 98.9853 },
            { name: 'Singapore', country: 'Singapore', lat: 1.3521, lon: 103.8198 },
            { name: 'Kuala Lumpur', country: 'Malaysia', lat: 3.1390, lon: 101.6869 },
            { name: 'Penang', country: 'Malaysia', lat: 5.4141, lon: 100.3288 },
            { name: 'Jakarta', country: 'Indonesia', lat: -6.2088, lon: 106.8456 },
            { name: 'Bali', country: 'Indonesia', lat: -8.3405, lon: 115.0920 },
            { name: 'Manila', country: 'Philippines', lat: 14.5995, lon: 120.9842 },
            { name: 'Hanoi', country: 'Vietnam', lat: 21.0285, lon: 105.8542 },
            { name: 'Ho Chi Minh City', country: 'Vietnam', lat: 10.8231, lon: 106.6297 },
            
            // Oceania
            { name: 'Sydney', country: 'Australia', lat: -33.8688, lon: 151.2093 },
            { name: 'Melbourne', country: 'Australia', lat: -37.8136, lon: 144.9631 },
            { name: 'Brisbane', country: 'Australia', lat: -27.4698, lon: 153.0251 },
            { name: 'Perth', country: 'Australia', lat: -31.9505, lon: 115.8605 },
            { name: 'Adelaide', country: 'Australia', lat: -34.9285, lon: 138.6007 },
            { name: 'Gold Coast', country: 'Australia', lat: -28.0167, lon: 153.4000 },
            { name: 'Auckland', country: 'New Zealand', lat: -36.8485, lon: 174.7633 },
            { name: 'Wellington', country: 'New Zealand', lat: -41.2865, lon: 174.7762 },
            { name: 'Queenstown', country: 'New Zealand', lat: -45.0312, lon: 168.6626 },
            { name: 'Fiji', country: 'Fiji', lat: -17.7134, lon: 178.0650 }
        ];
        
        let birthData = {
            name: '',
            date: null,
            time: null,
            location: null,
            lat: null,
            lon: null
        };
        
        let calculatedPlanetaryPositions = {};
        
        const planetColors = {
            sun: '#FFD700',
            moon: '#C0C0C0',
            mercury: '#87CEEB',
            venus: '#FF69B4',
            mars: '#FF4500',
            jupiter: '#FFA500',
            saturn: '#8B4513',
            mc: '#FFFFFF',
            ic: '#CCCCCC',
            asc: '#E0E0E0',
            dsc: '#B0B0B0'
        };
        
        const planetSymbols = {
            sun: '☉',
            moon: '☽',
            mercury: '☿',
            venus: '♀',
            mars: '♂',
            jupiter: '♃',
            saturn: '♄',
            mc: 'MC',
            ic: 'IC',
            asc: 'AC',
            dsc: 'DC'
        };
        
        const zodiacSigns = [
            { name: 'Aries', symbol: '♈', start: 0 },
            { name: 'Taurus', symbol: '♉', start: 30 },
            { name: 'Gemini', symbol: '♊', start: 60 },
            { name: 'Cancer', symbol: '♋', start: 90 },
            { name: 'Leo', symbol: '♌', start: 120 },
            { name: 'Virgo', symbol: '♍', start: 150 },
            { name: 'Libra', symbol: '♎', start: 180 },
            { name: 'Scorpio', symbol: '♏', start: 210 },
            { name: 'Sagittarius', symbol: '♐', start: 240 },
            { name: 'Capricorn', symbol: '♑', start: 270 },
            { name: 'Aquarius', symbol: '♒', start: 300 },
            { name: 'Pisces', symbol: '♓', start: 330 }
        ];
        
        const planetNames = {
            sun: 'Sun',
            moon: 'Moon',
            mercury: 'Mercury',
            venus: 'Venus',
            mars: 'Mars',
            jupiter: 'Jupiter',
            saturn: 'Saturn',
            mc: 'Midheaven',
            ic: 'IC',
            asc: 'Ascendant',
            dsc: 'Descendant'
        };
        
        const categoryPlanets = {
            career: ['sun', 'jupiter', 'saturn', 'mars'],
            studies: ['mercury', 'jupiter', 'sun'],
            love: ['venus', 'moon'],
            family: ['moon', 'venus', 'jupiter']
        };
        
        const categorySubtitles = {
            career: 'These are the places where your professional star shines brightest.',
            studies: 'Here, your mind expands and learning flows naturally.',
            love: 'In these locations, romance and connection flourish.',
            family: 'These places feel like home, nurturing your roots.'
        };
        
        // Autocomplete
        const birthLocationInput = document.getElementById('birthLocation');
        const suggestionsDiv = document.getElementById('suggestions');
        
        birthLocationInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            
            if (query.length < 2) {
                suggestionsDiv.classList.remove('active');
                return;
            }
            
            const matches = worldCities.filter(city => 
                city.name.toLowerCase().includes(query) || 
                city.country.toLowerCase().includes(query)
            ).slice(0, 8);
            
            if (matches.length > 0) {
                suggestionsDiv.innerHTML = '';
                matches.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `
                        <div style="font-weight: 500;">${city.name}</div>
                        <div style="font-size: 0.875rem; color: #999;">${city.country}</div>
                    `;
                    div.onclick = function() {
                        selectCity(city.name, city.country, city.lat, city.lon);
                    };
                    suggestionsDiv.appendChild(div);
                });
                suggestionsDiv.classList.add('active');
            } else {
                suggestionsDiv.classList.remove('active');
            }
        });
        
        function selectCity(name, country, lat, lon) {
            birthLocationInput.value = name + ', ' + country;
            birthData.lat = lat;
            birthData.lon = lon;
            suggestionsDiv.classList.remove('active');
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-group')) {
                suggestionsDiv.classList.remove('active');
            }
        });
        
        function goToHomepage() {
            const currentScreen = document.querySelector('.screen.active').id;
            
            if (currentScreen === 'screen1') {
                return;
            }
            
            const confirmMsg = currentScreen === 'screen2' 
                ? 'Are you sure you want to start over? Your birth details will be cleared.'
                : 'Are you sure you want to start over? Your map and birth details will be lost.';
            
            if (confirm(confirmMsg)) {
                birthData = {
                    name: '',
                    date: null,
                    time: null,
                    location: null,
                    lat: null,
                    lon: null
                };
                calculatedPlanetaryPositions = {};
                
                document.getElementById('userName').value = '';
                document.getElementById('birthDate').value = '';
                document.getElementById('birthTime').value = '';
                document.getElementById('birthLocation').value = '';
                
                nextScreen(1);
            }
        }
        
        function validateAndContinue() {
            const name = document.getElementById('userName').value.trim();
            const date = document.getElementById('birthDate').value;
            const time = document.getElementById('birthTime').value;
            const location = document.getElementById('birthLocation').value;
            
            let valid = true;
            
            if (!name) {
                document.getElementById('nameError').textContent = 'We would love to know your name';
                valid = false;
            } else {
                document.getElementById('nameError').textContent = '';
            }
            
            if (!date) {
                document.getElementById('dateError').textContent = 'Your birth date helps us map the stars';
                valid = false;
            } else {
                document.getElementById('dateError').textContent = '';
            }
            
            if (!time) {
                document.getElementById('timeError').textContent = 'Exact timing matters for accuracy';
                valid = false;
            } else {
                document.getElementById('timeError').textContent = '';
            }
            
            if (!location) {
                document.getElementById('locationError').textContent = 'Where did your journey begin?';
                valid = false;
            } else {
                document.getElementById('locationError').textContent = '';
            }
            
            if (valid) {
                birthData.name = name;
                birthData.date = date;
                birthData.time = time;
                birthData.location = location;
                
                calculatePlanetaryPositions();
                document.getElementById('greetingText').textContent = 'Hi ' + name + ',';
                
                nextScreen(2);
            }
        }
        
        function calculatePlanetaryPositions() {
            const dateObj = new Date(birthData.date + 'T' + birthData.time);
            const julianDay = dateToJulianDay(dateObj);
            
            // Calculate planetary positions using simplified astronomical algorithms
            calculatedPlanetaryPositions = {
                sun: calculateSunPosition(julianDay),
                moon: calculateMoonPosition(julianDay),
                mercury: calculateMercuryPosition(julianDay),
                venus: calculateVenusPosition(julianDay),
                mars: calculateMarsPosition(julianDay),
                jupiter: calculateJupiterPosition(julianDay),
                saturn: calculateSaturnPosition(julianDay)
            };
            
            // Calculate houses based on birth location
            const timeHours = parseFloat(birthData.time.split(':')[0]) + parseFloat(birthData.time.split(':')[1]) / 60;
            const lst = calculateLocalSiderealTime(julianDay, birthData.lon, timeHours);
            
            calculatedPlanetaryPositions.asc = calculateAscendant(lst, birthData.lat);
            calculatedPlanetaryPositions.mc = (lst * 15) % 360; // MC is LST in degrees
            calculatedPlanetaryPositions.dsc = (calculatedPlanetaryPositions.asc + 180) % 360;
            calculatedPlanetaryPositions.ic = (calculatedPlanetaryPositions.mc + 180) % 360;
        }
        
        function dateToJulianDay(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours() + date.getMinutes() / 60 + date.getSeconds() / 3600;
            
            let y = year;
            let m = month;
            
            if (m <= 2) {
                y -= 1;
                m += 12;
            }
            
            const a = Math.floor(y / 100);
            const b = 2 - a + Math.floor(a / 4);
            
            const jd = Math.floor(365.25 * (y + 4716)) + 
                       Math.floor(30.6001 * (m + 1)) + 
                       day + hour / 24 + b - 1524.5;
            
            return jd;
        }
        
        function calculateSunPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            // Mean longitude
            let L = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
            
            // Mean anomaly
            let M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
            M = M * Math.PI / 180;
            
            // Equation of center
            const C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M) +
                     (0.019993 - 0.000101 * T) * Math.sin(2 * M) +
                     0.000289 * Math.sin(3 * M);
            
            // True longitude
            const longitude = (L + C) % 360;
            
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateMoonPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            // Moon's mean longitude
            let L = 218.3164477 + 481267.88123421 * T - 0.0015786 * T * T;
            
            // Mean elongation
            let D = 297.8501921 + 445267.1114034 * T - 0.0018819 * T * T;
            D = D * Math.PI / 180;
            
            // Sun's mean anomaly
            let M = 357.5291092 + 35999.0502909 * T - 0.0001536 * T * T;
            M = M * Math.PI / 180;
            
            // Moon's mean anomaly
            let Mp = 134.9633964 + 477198.8675055 * T + 0.0087414 * T * T;
            Mp = Mp * Math.PI / 180;
            
            // Moon's argument of latitude
            let F = 93.2720950 + 483202.0175233 * T - 0.0036539 * T * T;
            F = F * Math.PI / 180;
            
            // Periodic terms
            const longitude = L + 
                6.288774 * Math.sin(Mp) +
                1.274027 * Math.sin(2 * D - Mp) +
                0.658314 * Math.sin(2 * D) +
                0.213618 * Math.sin(2 * Mp) -
                0.185116 * Math.sin(M) -
                0.114332 * Math.sin(2 * F);
            
            return ((longitude % 360) + 360) % 360;
        }
        
        function calculateMercuryPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L = 252.250906 + 149472.6746358 * T;
            let M = 174.7948 + 149472.51529 * T;
            M = M * Math.PI / 180;
            
            const C = 23.4400 * Math.sin(M) + 2.9818 * Math.sin(2 * M) + 
                     0.5255 * Math.sin(3 * M);
            
            const longitude = (L + C) % 360;
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateVenusPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L = 181.979801 + 58517.8156760 * T;
            let M = 50.4071 + 58517.8039 * T;
            M = M * Math.PI / 180;
            
            const C = 0.7758 * Math.sin(M) + 0.0033 * Math.sin(2 * M);
            
            const longitude = (L + C) % 360;
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateMarsPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L = 355.433 + 19140.2993 * T;
            let M = 19.3730 + 19140.299 * T;
            M = M * Math.PI / 180;
            
            const C = 10.691 * Math.sin(M) + 0.623 * Math.sin(2 * M) + 
                     0.050 * Math.sin(3 * M);
            
            const longitude = (L + C) % 360;
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateJupiterPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L = 34.351519 + 3034.9056606 * T;
            let M = 20.020 + 3034.906 * T;
            M = M * Math.PI / 180;
            
            const C = 5.555 * Math.sin(M) + 0.168 * Math.sin(2 * M);
            
            const longitude = (L + C) % 360;
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateSaturnPosition(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L = 50.077444 + 1222.1138488 * T;
            let M = 317.021 + 1222.114 * T;
            M = M * Math.PI / 180;
            
            const C = 6.406 * Math.sin(M) + 0.392 * Math.sin(2 * M);
            
            const longitude = (L + C) % 360;
            return longitude < 0 ? longitude + 360 : longitude;
        }
        
        function calculateLocalSiderealTime(jd, lon, hours) {
            const T = (jd - 2451545.0) / 36525.0;
            
            // Greenwich Mean Sidereal Time at 0h UT
            let gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 
                      0.000387933 * T * T - T * T * T / 38710000.0;
            
            // Add local time offset
            gmst += hours * 15;
            
            // Convert to Local Sidereal Time
            let lst = gmst + lon;
            
            // Normalize to 0-360
            lst = ((lst % 360) + 360) % 360;
            
            // Convert to hours
            return lst / 15;
        }
        
        function calculateAscendant(lst, lat) {
            // Simplified ascendant calculation
            // This uses the equal house system approximation
            const lstDegrees = lst * 15;
            
            // Adjust for latitude (simplified)
            const latRad = lat * Math.PI / 180;
            const obliquity = 23.4397; // Earth's obliquity
            const oblRad = obliquity * Math.PI / 180;
            
            // Calculate ascendant using spherical trigonometry (simplified)
            const ramc = lstDegrees * Math.PI / 180;
            const asc = Math.atan2(Math.cos(ramc), 
                                   -Math.sin(ramc) * Math.cos(oblRad) - 
                                   Math.tan(latRad) * Math.sin(oblRad)) * 180 / Math.PI;
            
            return ((asc % 360) + 360) % 360;
        }
        
        function nextScreen(screenNumber) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen' + screenNumber).classList.add('active');
        }
        
        function calculateMap(category) {
            const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
            document.getElementById('selectedCategory').textContent = 'Your ' + categoryTitle + ' Map';
            document.getElementById('mapSubtitle').textContent = categorySubtitles[category];
            
            nextScreen(3);
            
            const planets = categoryPlanets[category];
            drawAstrocartographyMap(planets, category);
        }
        
        function drawAstrocartographyMap(planets, category) {
            const canvas = document.getElementById('mapCanvas');
            const ctx = canvas.getContext('2d');
            
            // Responsive canvas sizing
            const isMobile = window.innerWidth < 768;
            canvas.width = isMobile ? 800 : canvas.offsetWidth;
            canvas.height = isMobile ? 600 : 900;
            
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            drawWorldMapSVG(ctx, width, height);
            
            const citiesOnLines = calculateCitiesOnPlanetaryLines(planets);
            
            drawAstroLines(ctx, width, height, planets);
            drawCityMarkers(ctx, width, height, citiesOnLines);
            
            updateLegend(planets);
            showInterpretations(category, planets);
            showCityList(citiesOnLines, category);
        }
        
        function calculateCitiesOnPlanetaryLines(planets) {
            const citiesOnLines = [];
            
            planets.forEach(planet => {
                const planetLon = calculatedPlanetaryPositions[planet];
                const declination = getPlanetDeclination(planet);
                
                worldCities.forEach(city => {
                    let nearestLine = null;
                    let minDistance = Infinity;
                    
                    // MC Line - vertical at planet longitude
                    const mcLon = planetLon;
                    const mcDist = Math.abs(normalizeLon(city.lon - mcLon));
                    if (mcDist < 5 && mcDist < minDistance) {
                        minDistance = mcDist;
                        nearestLine = planet + '_mc';
                    }
                    
                    // IC Line - vertical opposite MC
                    const icLon = (planetLon + 180) % 360;
                    const icDist = Math.abs(normalizeLon(city.lon - icLon));
                    if (icDist < 5 && icDist < minDistance) {
                        minDistance = icDist;
                        nearestLine = planet + '_ic';
                    }
                    
                    // ASC Line - curved, calculate for city's latitude
                    const ascLon = calculateASCLongitude(planetLon, declination, city.lat);
                    if (ascLon !== null) {
                        const ascDist = Math.abs(normalizeLon(city.lon - ascLon));
                        if (ascDist < 5 && ascDist < minDistance) {
                            minDistance = ascDist;
                            nearestLine = planet + '_asc';
                        }
                    }
                    
                    // DSC Line - curved, opposite ASC
                    const dscLon = calculateDSCLongitude(planetLon, declination, city.lat);
                    if (dscLon !== null) {
                        const dscDist = Math.abs(normalizeLon(city.lon - dscLon));
                        if (dscDist < 5 && dscDist < minDistance) {
                            minDistance = dscDist;
                            nearestLine = planet + '_dsc';
                        }
                    }
                    
                    if (nearestLine) {
                        const existingCity = citiesOnLines.find(c => c.name === city.name);
                        if (existingCity) {
                            if (!existingCity.lines.includes(nearestLine)) {
                                existingCity.lines.push(nearestLine);
                            }
                        } else {
                            citiesOnLines.push({
                                name: city.name,
                                country: city.country,
                                lat: city.lat,
                                lon: city.lon,
                                lines: [nearestLine]
                            });
                        }
                    }
                });
            });
            
            // Sort by number of lines (most to least)
            citiesOnLines.sort((a, b) => b.lines.length - a.lines.length);
            
            return citiesOnLines.slice(0, 8);
        }
        
        function calculateAstrocartographyLines(planet, planetLon, birthLat, birthLon) {
            // This function is still used for reference but actual drawing uses curved calculations
            const declination = getPlanetDeclination(planet);
            
            return {
                mc: planetLon,
                ic: (planetLon + 180) % 360,
                asc: calculateASCLongitude(planetLon, declination, 0), // At equator for reference
                dsc: calculateDSCLongitude(planetLon, declination, 0)
            };
        }
        
        function normalizeLon(lon) {
            while (lon > 180) lon -= 360;
            while (lon < -180) lon += 360;
            return lon;
        }
        
        function drawWorldMapSVG(ctx, width, height) {
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2.5;
            ctx.fillStyle = '#0a0a0a';
            
            const scaleX = width / 360;
            const scaleY = height / 180;
            
            function lon2x(lon) { return (lon + 180) * scaleX; }
            function lat2y(lat) { return (90 - lat) * scaleY; }
            
            // North America - more accurate shape
            ctx.beginPath();
            // Alaska
            ctx.moveTo(lon2x(-165), lat2y(65));
            ctx.lineTo(lon2x(-163), lat2y(68));
            ctx.lineTo(lon2x(-156), lat2y(71));
            ctx.lineTo(lon2x(-145), lat2y(70));
            ctx.lineTo(lon2x(-141), lat2y(69));
            // Canada north
            ctx.lineTo(lon2x(-135), lat2y(69));
            ctx.lineTo(lon2x(-130), lat2y(70));
            ctx.lineTo(lon2x(-125), lat2y(69));
            ctx.lineTo(lon2x(-120), lat2y(70));
            ctx.lineTo(lon2x(-110), lat2y(70));
            ctx.lineTo(lon2x(-100), lat2y(70));
            ctx.lineTo(lon2x(-95), lat2y(69));
            ctx.lineTo(lon2x(-85), lat2y(68));
            ctx.lineTo(lon2x(-80), lat2y(67));
            ctx.lineTo(lon2x(-75), lat2y(65));
            ctx.lineTo(lon2x(-70), lat2y(62));
            ctx.lineTo(lon2x(-65), lat2y(60));
            // Eastern Canada
            ctx.lineTo(lon2x(-60), lat2y(58));
            ctx.lineTo(lon2x(-57), lat2y(55));
            ctx.lineTo(lon2x(-60), lat2y(52));
            ctx.lineTo(lon2x(-64), lat2y(48));
            ctx.lineTo(lon2x(-67), lat2y(45));
            // East Coast US
            ctx.lineTo(lon2x(-70), lat2y(43));
            ctx.lineTo(lon2x(-74), lat2y(40));
            ctx.lineTo(lon2x(-75), lat2y(37));
            ctx.lineTo(lon2x(-76), lat2y(34));
            ctx.lineTo(lon2x(-80), lat2y(32));
            ctx.lineTo(lon2x(-81), lat2y(28));
            // Florida
            ctx.lineTo(lon2x(-80), lat2y(25));
            ctx.lineTo(lon2x(-82), lat2y(27));
            // Gulf Coast
            ctx.lineTo(lon2x(-85), lat2y(30));
            ctx.lineTo(lon2x(-88), lat2y(30));
            ctx.lineTo(lon2x(-90), lat2y(29));
            ctx.lineTo(lon2x(-94), lat2y(29));
            ctx.lineTo(lon2x(-97), lat2y(26));
            // Mexico
            ctx.lineTo(lon2x(-99), lat2y(25));
            ctx.lineTo(lon2x(-102), lat2y(22));
            ctx.lineTo(lon2x(-105), lat2y(20));
            ctx.lineTo(lon2x(-108), lat2y(18));
            ctx.lineTo(lon2x(-110), lat2y(16));
            ctx.lineTo(lon2x(-112), lat2y(14));
            ctx.lineTo(lon2x(-109), lat2y(12));
            ctx.lineTo(lon2x(-106), lat2y(12));
            ctx.lineTo(lon2x(-103), lat2y(14));
            ctx.lineTo(lon2x(-100), lat2y(16));
            ctx.lineTo(lon2x(-97), lat2y(18));
            ctx.lineTo(lon2x(-94), lat2y(16));
            ctx.lineTo(lon2x(-92), lat2y(14));
            ctx.lineTo(lon2x(-90), lat2y(14));
            // Central America
            ctx.lineTo(lon2x(-88), lat2y(14));
            ctx.lineTo(lon2x(-86), lat2y(12));
            ctx.lineTo(lon2x(-84), lat2y(10));
            ctx.lineTo(lon2x(-82), lat2y(9));
            ctx.lineTo(lon2x(-80), lat2y(8));
            ctx.lineTo(lon2x(-78), lat2y(8));
            ctx.lineTo(lon2x(-77), lat2y(9));
            ctx.lineTo(lon2x(-79), lat2y(10));
            ctx.lineTo(lon2x(-81), lat2y(11));
            ctx.lineTo(lon2x(-83), lat2y(13));
            ctx.lineTo(lon2x(-87), lat2y(16));
            // West Coast Mexico
            ctx.lineTo(lon2x(-95), lat2y(19));
            ctx.lineTo(lon2x(-100), lat2y(22));
            ctx.lineTo(lon2x(-105), lat2y(24));
            ctx.lineTo(lon2x(-110), lat2y(27));
            ctx.lineTo(lon2x(-112), lat2y(28));
            ctx.lineTo(lon2x(-114), lat2y(29));
            ctx.lineTo(lon2x(-115), lat2y(31));
            // West Coast US
            ctx.lineTo(lon2x(-117), lat2y(32));
            ctx.lineTo(lon2x(-118), lat2y(34));
            ctx.lineTo(lon2x(-120), lat2y(36));
            ctx.lineTo(lon2x(-122), lat2y(38));
            ctx.lineTo(lon2x(-123), lat2y(42));
            ctx.lineTo(lon2x(-124), lat2y(46));
            ctx.lineTo(lon2x(-123), lat2y(48));
            // West Coast Canada
            ctx.lineTo(lon2x(-125), lat2y(50));
            ctx.lineTo(lon2x(-128), lat2y(52));
            ctx.lineTo(lon2x(-130), lat2y(54));
            ctx.lineTo(lon2x(-133), lat2y(56));
            ctx.lineTo(lon2x(-135), lat2y(58));
            ctx.lineTo(lon2x(-138), lat2y(59));
            // Back to Alaska
            ctx.lineTo(lon2x(-141), lat2y(60));
            ctx.lineTo(lon2x(-145), lat2y(61));
            ctx.lineTo(lon2x(-150), lat2y(62));
            ctx.lineTo(lon2x(-155), lat2y(63));
            ctx.lineTo(lon2x(-160), lat2y(64));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Greenland
            ctx.beginPath();
            ctx.moveTo(lon2x(-73), lat2y(83));
            ctx.lineTo(lon2x(-70), lat2y(83));
            ctx.lineTo(lon2x(-65), lat2y(82));
            ctx.lineTo(lon2x(-60), lat2y(81));
            ctx.lineTo(lon2x(-55), lat2y(80));
            ctx.lineTo(lon2x(-50), lat2y(78));
            ctx.lineTo(lon2x(-45), lat2y(76));
            ctx.lineTo(lon2x(-42), lat2y(73));
            ctx.lineTo(lon2x(-40), lat2y(70));
            ctx.lineTo(lon2x(-42), lat2y(68));
            ctx.lineTo(lon2x(-45), lat2y(66));
            ctx.lineTo(lon2x(-48), lat2y(64));
            ctx.lineTo(lon2x(-50), lat2y(62));
            ctx.lineTo(lon2x(-52), lat2y(60));
            ctx.lineTo(lon2x(-54), lat2y(62));
            ctx.lineTo(lon2x(-56), lat2y(64));
            ctx.lineTo(lon2x(-58), lat2y(66));
            ctx.lineTo(lon2x(-62), lat2y(68));
            ctx.lineTo(lon2x(-66), lat2y(70));
            ctx.lineTo(lon2x(-70), lat2y(72));
            ctx.lineTo(lon2x(-73), lat2y(75));
            ctx.lineTo(lon2x(-75), lat2y(78));
            ctx.lineTo(lon2x(-74), lat2y(81));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Caribbean Islands
            ctx.beginPath();
            // Cuba
            ctx.moveTo(lon2x(-84), lat2y(23));
            ctx.lineTo(lon2x(-82), lat2y(23));
            ctx.lineTo(lon2x(-80), lat2y(22));
            ctx.lineTo(lon2x(-78), lat2y(21));
            ctx.lineTo(lon2x(-76), lat2y(20));
            ctx.lineTo(lon2x(-75), lat2y(20));
            ctx.lineTo(lon2x(-76), lat2y(21));
            ctx.lineTo(lon2x(-78), lat2y(22));
            ctx.lineTo(lon2x(-82), lat2y(23));
            ctx.lineTo(lon2x(-84), lat2y(22));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Jamaica
            ctx.beginPath();
            ctx.arc(lon2x(-77.5), lat2y(18.2), 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Hispaniola
            ctx.beginPath();
            ctx.moveTo(lon2x(-74), lat2y(20));
            ctx.lineTo(lon2x(-72), lat2y(20));
            ctx.lineTo(lon2x(-71), lat2y(19));
            ctx.lineTo(lon2x(-68), lat2y(19));
            ctx.lineTo(lon2x(-68), lat2y(18));
            ctx.lineTo(lon2x(-71), lat2y(18));
            ctx.lineTo(lon2x(-72), lat2y(19));
            ctx.lineTo(lon2x(-74), lat2y(19));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // South America - more detailed
            ctx.beginPath();
            // Colombia/Venezuela
            ctx.moveTo(lon2x(-77), lat2y(12));
            ctx.lineTo(lon2x(-75), lat2y(11));
            ctx.lineTo(lon2x(-72), lat2y(11));
            ctx.lineTo(lon2x(-70), lat2y(12));
            ctx.lineTo(lon2x(-68), lat2y(11));
            ctx.lineTo(lon2x(-66), lat2y(10));
            ctx.lineTo(lon2x(-64), lat2y(10));
            ctx.lineTo(lon2x(-62), lat2y(9));
            ctx.lineTo(lon2x(-60), lat2y(7));
            // Guianas/Brazil north
            ctx.lineTo(lon2x(-58), lat2y(5));
            ctx.lineTo(lon2x(-56), lat2y(3));
            ctx.lineTo(lon2x(-54), lat2y(2));
            ctx.lineTo(lon2x(-52), lat2y(2));
            ctx.lineTo(lon2x(-50), lat2y(1));
            ctx.lineTo(lon2x(-48), lat2y(0));
            ctx.lineTo(lon2x(-46), lat2y(-1));
            ctx.lineTo(lon2x(-44), lat2y(-2));
            // Brazil east coast
            ctx.lineTo(lon2x(-42), lat2y(-3));
            ctx.lineTo(lon2x(-40), lat2y(-5));
            ctx.lineTo(lon2x(-38), lat2y(-8));
            ctx.lineTo(lon2x(-36), lat2y(-10));
            ctx.lineTo(lon2x(-35), lat2y(-12));
            ctx.lineTo(lon2x(-35), lat2y(-15));
            ctx.lineTo(lon2x(-36), lat2y(-18));
            ctx.lineTo(lon2x(-38), lat2y(-20));
            ctx.lineTo(lon2x(-40), lat2y(-22));
            ctx.lineTo(lon2x(-42), lat2y(-23));
            ctx.lineTo(lon2x(-44), lat2y(-24));
            // Southern Brazil
            ctx.lineTo(lon2x(-46), lat2y(-24));
            ctx.lineTo(lon2x(-48), lat2y(-26));
            ctx.lineTo(lon2x(-50), lat2y(-28));
            ctx.lineTo(lon2x(-52), lat2y(-30));
            ctx.lineTo(lon2x(-54), lat2y(-32));
            // Uruguay/Argentina
            ctx.lineTo(lon2x(-56), lat2y(-34));
            ctx.lineTo(lon2x(-58), lat2y(-35));
            ctx.lineTo(lon2x(-60), lat2y(-36));
            ctx.lineTo(lon2x(-62), lat2y(-38));
            ctx.lineTo(lon2x(-64), lat2y(-40));
            ctx.lineTo(lon2x(-65), lat2y(-42));
            ctx.lineTo(lon2x(-66), lat2y(-44));
            ctx.lineTo(lon2x(-68), lat2y(-47));
            ctx.lineTo(lon2x(-70), lat2y(-50));
            ctx.lineTo(lon2x(-72), lat2y(-52));
            // Southern tip
            ctx.lineTo(lon2x(-71), lat2y(-54));
            ctx.lineTo(lon2x(-69), lat2y(-55));
            ctx.lineTo(lon2x(-67), lat2y(-54));
            // Chile west coast
            ctx.lineTo(lon2x(-70), lat2y(-52));
            ctx.lineTo(lon2x(-72), lat2y(-48));
            ctx.lineTo(lon2x(-73), lat2y(-44));
            ctx.lineTo(lon2x(-73), lat2y(-40));
            ctx.lineTo(lon2x(-72), lat2y(-36));
            ctx.lineTo(lon2x(-71), lat2y(-32));
            ctx.lineTo(lon2x(-71), lat2y(-28));
            ctx.lineTo(lon2x(-70), lat2y(-24));
            ctx.lineTo(lon2x(-70), lat2y(-20));
            // Peru
            ctx.lineTo(lon2x(-71), lat2y(-16));
            ctx.lineTo(lon2x(-72), lat2y(-12));
            ctx.lineTo(lon2x(-74), lat2y(-8));
            ctx.lineTo(lon2x(-76), lat2y(-4));
            ctx.lineTo(lon2x(-78), lat2y(-1));
            // Ecuador
            ctx.lineTo(lon2x(-79), lat2y(1));
            ctx.lineTo(lon2x(-80), lat2y(3));
            ctx.lineTo(lon2x(-80), lat2y(5));
            ctx.lineTo(lon2x(-79), lat2y(7));
            ctx.lineTo(lon2x(-78), lat2y(9));
            ctx.lineTo(lon2x(-77), lat2y(11));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // EURASIA (Europe, Middle East, and Asia connected as one landmass)
            ctx.beginPath();
            // Iceland
            ctx.moveTo(lon2x(-24), lat2y(66));
            ctx.lineTo(lon2x(-22), lat2y(66));
            ctx.lineTo(lon2x(-20), lat2y(65));
            ctx.lineTo(lon2x(-18), lat2y(65));
            ctx.lineTo(lon2x(-16), lat2y(64));
            ctx.lineTo(lon2x(-14), lat2y(65));
            ctx.lineTo(lon2x(-16), lat2y(66));
            ctx.lineTo(lon2x(-18), lat2y(66));
            ctx.lineTo(lon2x(-22), lat2y(67));
            ctx.lineTo(lon2x(-24), lat2y(67));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // British Isles
            ctx.beginPath();
            // Ireland
            ctx.moveTo(lon2x(-10), lat2y(55));
            ctx.lineTo(lon2x(-9), lat2y(55));
            ctx.lineTo(lon2x(-8), lat2y(54));
            ctx.lineTo(lon2x(-6), lat2y(53));
            ctx.lineTo(lon2x(-6), lat2y(52));
            ctx.lineTo(lon2x(-7), lat2y(51));
            ctx.lineTo(lon2x(-9), lat2y(52));
            ctx.lineTo(lon2x(-10), lat2y(53));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Great Britain
            ctx.beginPath();
            ctx.moveTo(lon2x(-5), lat2y(59));
            ctx.lineTo(lon2x(-4), lat2y(59));
            ctx.lineTo(lon2x(-3), lat2y(58));
            ctx.lineTo(lon2x(-2), lat2y(57));
            ctx.lineTo(lon2x(-1), lat2y(56));
            ctx.lineTo(lon2x(0), lat2y(55));
            ctx.lineTo(lon2x(1), lat2y(54));
            ctx.lineTo(lon2x(1), lat2y(53));
            ctx.lineTo(lon2x(1), lat2y(52));
            ctx.lineTo(lon2x(0), lat2y(51));
            ctx.lineTo(lon2x(-1), lat2y(50));
            ctx.lineTo(lon2x(-2), lat2y(51));
            ctx.lineTo(lon2x(-3), lat2y(52));
            ctx.lineTo(lon2x(-4), lat2y(53));
            ctx.lineTo(lon2x(-5), lat2y(55));
            ctx.lineTo(lon2x(-5), lat2y(57));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Main Eurasia landmass
            ctx.beginPath();
            // Scandinavia
            ctx.moveTo(lon2x(5), lat2y(60));
            ctx.lineTo(lon2x(8), lat2y(63));
            ctx.lineTo(lon2x(12), lat2y(65));
            ctx.lineTo(lon2x(16), lat2y(67));
            ctx.lineTo(lon2x(20), lat2y(69));
            ctx.lineTo(lon2x(24), lat2y(70));
            ctx.lineTo(lon2x(28), lat2y(70));
            ctx.lineTo(lon2x(30), lat2y(69));
            ctx.lineTo(lon2x(31), lat2y(67));
            ctx.lineTo(lon2x(30), lat2y(65));
            ctx.lineTo(lon2x(28), lat2y(63));
            ctx.lineTo(lon2x(26), lat2y(61));
            ctx.lineTo(lon2x(24), lat2y(60));
            ctx.lineTo(lon2x(22), lat2y(59));
            // Russia/Eastern Europe
            ctx.lineTo(lon2x(24), lat2y(57));
            ctx.lineTo(lon2x(26), lat2y(55));
            ctx.lineTo(lon2x(28), lat2y(53));
            ctx.lineTo(lon2x(30), lat2y(51));
            ctx.lineTo(lon2x(32), lat2y(49));
            ctx.lineTo(lon2x(34), lat2y(47));
            ctx.lineTo(lon2x(36), lat2y(46));
            ctx.lineTo(lon2x(38), lat2y(45));
            ctx.lineTo(lon2x(40), lat2y(44));
            // Continuing through Russia to Siberia
            ctx.lineTo(lon2x(50), lat2y(45));
            ctx.lineTo(lon2x(60), lat2y(50));
            ctx.lineTo(lon2x(70), lat2y(55));
            ctx.lineTo(lon2x(80), lat2y(60));
            ctx.lineTo(lon2x(90), lat2y(65));
            ctx.lineTo(lon2x(100), lat2y(70));
            ctx.lineTo(lon2x(110), lat2y(72));
            ctx.lineTo(lon2x(120), lat2y(73));
            ctx.lineTo(lon2x(130), lat2y(72));
            ctx.lineTo(lon2x(140), lat2y(70));
            ctx.lineTo(lon2x(150), lat2y(68));
            ctx.lineTo(lon2x(160), lat2y(66));
            ctx.lineTo(lon2x(165), lat2y(64));
            ctx.lineTo(lon2x(168), lat2y(62));
            ctx.lineTo(lon2x(170), lat2y(60));
            // Far East Russia
            ctx.lineTo(lon2x(169), lat2y(58));
            ctx.lineTo(lon2x(168), lat2y(56));
            ctx.lineTo(lon2x(166), lat2y(54));
            ctx.lineTo(lon2x(164), lat2y(52));
            ctx.lineTo(lon2x(162), lat2y(50));
            ctx.lineTo(lon2x(160), lat2y(48));
            ctx.lineTo(lon2x(158), lat2y(46));
            ctx.lineTo(lon2x(156), lat2y(45));
            ctx.lineTo(lon2x(154), lat2y(44));
            // Korea/China Northeast
            ctx.lineTo(lon2x(150), lat2y(43));
            ctx.lineTo(lon2x(146), lat2y(42));
            ctx.lineTo(lon2x(142), lat2y(42));
            ctx.lineTo(lon2x(138), lat2y(42));
            ctx.lineTo(lon2x(134), lat2y(43));
            ctx.lineTo(lon2x(130), lat2y(44));
            ctx.lineTo(lon2x(128), lat2y(45));
            // China East Coast
            ctx.lineTo(lon2x(126), lat2y(44));
            ctx.lineTo(lon2x(124), lat2y(43));
            ctx.lineTo(lon2x(122), lat2y(42));
            ctx.lineTo(lon2x(121), lat2y(40));
            ctx.lineTo(lon2x(120), lat2y(38));
            ctx.lineTo(lon2x(120), lat2y(35));
            ctx.lineTo(lon2x(121), lat2y(32));
            ctx.lineTo(lon2x(121), lat2y(28));
            ctx.lineTo(lon2x(120), lat2y(25));
            ctx.lineTo(lon2x(118), lat2y(23));
            ctx.lineTo(lon2x(116), lat2y(22));
            ctx.lineTo(lon2x(114), lat2y(21));
            ctx.lineTo(lon2x(112), lat2y(21));
            ctx.lineTo(lon2x(110), lat2y(20));
            // Southeast Asia
            ctx.lineTo(lon2x(108), lat2y(19));
            ctx.lineTo(lon2x(106), lat2y(17));
            ctx.lineTo(lon2x(104), lat2y(15));
            ctx.lineTo(lon2x(102), lat2y(13));
            ctx.lineTo(lon2x(100), lat2y(11));
            ctx.lineTo(lon2x(99), lat2y(9));
            ctx.lineTo(lon2x(98), lat2y(7));
            ctx.lineTo(lon2x(98), lat2y(5));
            // Malay Peninsula
            ctx.lineTo(lon2x(100), lat2y(4));
            ctx.lineTo(lon2x(101), lat2y(2));
            ctx.lineTo(lon2x(102), lat2y(1));
            ctx.lineTo(lon2x(103), lat2y(1));
            ctx.lineTo(lon2x(103), lat2y(2));
            ctx.lineTo(lon2x(102), lat2y(4));
            ctx.lineTo(lon2x(101), lat2y(6));
            ctx.lineTo(lon2x(100), lat2y(8));
            // Back through India/Myanmar
            ctx.lineTo(lon2x(98), lat2y(10));
            ctx.lineTo(lon2x(96), lat2y(12));
            ctx.lineTo(lon2x(94), lat2y(15));
            ctx.lineTo(lon2x(92), lat2y(18));
            ctx.lineTo(lon2x(90), lat2y(21));
            ctx.lineTo(lon2x(88), lat2y(23));
            ctx.lineTo(lon2x(86), lat2y(25));
            ctx.lineTo(lon2x(84), lat2y(27));
            ctx.lineTo(lon2x(82), lat2y(28));
            ctx.lineTo(lon2x(80), lat2y(29));
            ctx.lineTo(lon2x(78), lat2y(30));
            ctx.lineTo(lon2x(76), lat2y(31));
            ctx.lineTo(lon2x(74), lat2y(32));
            ctx.lineTo(lon2x(72), lat2y(33));
            ctx.lineTo(lon2x(70), lat2y(34));
            // India west coast
            ctx.lineTo(lon2x(69), lat2y(32));
            ctx.lineTo(lon2x(68), lat2y(30));
            ctx.lineTo(lon2x(68), lat2y(27));
            ctx.lineTo(lon2x(68), lat2y(24));
            ctx.lineTo(lon2x(69), lat2y(22));
            ctx.lineTo(lon2x(70), lat2y(20));
            ctx.lineTo(lon2x(72), lat2y(19));
            ctx.lineTo(lon2x(74), lat2y(18));
            ctx.lineTo(lon2x(76), lat2y(16));
            ctx.lineTo(lon2x(77), lat2y(13));
            ctx.lineTo(lon2x(77), lat2y(10));
            ctx.lineTo(lon2x(76), lat2y(8));
            ctx.lineTo(lon2x(74), lat2y(9));
            ctx.lineTo(lon2x(72), lat2y(10));
            ctx.lineTo(lon2x(70), lat2y(12));
            ctx.lineTo(lon2x(68), lat2y(14));
            // Pakistan/Iran/Middle East
            ctx.lineTo(lon2x(66), lat2y(16));
            ctx.lineTo(lon2x(64), lat2y(18));
            ctx.lineTo(lon2x(62), lat2y(20));
            ctx.lineTo(lon2x(60), lat2y(23));
            ctx.lineTo(lon2x(58), lat2y(26));
            ctx.lineTo(lon2x(56), lat2y(28));
            ctx.lineTo(lon2x(54), lat2y(30));
            ctx.lineTo(lon2x(52), lat2y(32));
            ctx.lineTo(lon2x(50), lat2y(34));
            ctx.lineTo(lon2x(48), lat2y(36));
            ctx.lineTo(lon2x(46), lat2y(38));
            // Arabian Peninsula
            ctx.lineTo(lon2x(44), lat2y(37));
            ctx.lineTo(lon2x(42), lat2y(36));
            ctx.lineTo(lon2x(40), lat2y(34));
            ctx.lineTo(lon2x(38), lat2y(32));
            ctx.lineTo(lon2x(37), lat2y(30));
            ctx.lineTo(lon2x(36), lat2y(27));
            ctx.lineTo(lon2x(36), lat2y(24));
            ctx.lineTo(lon2x(37), lat2y(21));
            ctx.lineTo(lon2x(39), lat2y(18));
            ctx.lineTo(lon2x(41), lat2y(16));
            ctx.lineTo(lon2x(43), lat2y(14));
            ctx.lineTo(lon2x(45), lat2y(13));
            ctx.lineTo(lon2x(48), lat2y(12));
            ctx.lineTo(lon2x(51), lat2y(12));
            ctx.lineTo(lon2x(53), lat2y(13));
            ctx.lineTo(lon2x(55), lat2y(14));
            ctx.lineTo(lon2x(56), lat2y(16));
            ctx.lineTo(lon2x(56), lat2y(18));
            ctx.lineTo(lon2x(55), lat2y(20));
            ctx.lineTo(lon2x(54), lat2y(22));
            ctx.lineTo(lon2x(52), lat2y(24));
            ctx.lineTo(lon2x(50), lat2y(26));
            ctx.lineTo(lon2x(48), lat2y(28));
            // Through Iraq/Syria to Mediterranean
            ctx.lineTo(lon2x(46), lat2y(30));
            ctx.lineTo(lon2x(44), lat2y(32));
            ctx.lineTo(lon2x(42), lat2y(34));
            ctx.lineTo(lon2x(40), lat2y(36));
            ctx.lineTo(lon2x(38), lat2y(37));
            ctx.lineTo(lon2x(36), lat2y(38));
            ctx.lineTo(lon2x(34), lat2y(39));
            ctx.lineTo(lon2x(32), lat2y(40));
            // Turkey/Black Sea
            ctx.lineTo(lon2x(30), lat2y(41));
            ctx.lineTo(lon2x(28), lat2y(41));
            ctx.lineTo(lon2x(26), lat2y(40));
            ctx.lineTo(lon2x(24), lat2y(39));
            ctx.lineTo(lon2x(22), lat2y(38));
            ctx.lineTo(lon2x(21), lat2y(37));
            // Greece
            ctx.lineTo(lon2x(20), lat2y(37));
            ctx.lineTo(lon2x(21), lat2y(38));
            ctx.lineTo(lon2x(22), lat2y(39));
            ctx.lineTo(lon2x(23), lat2y(40));
            ctx.lineTo(lon2x(24), lat2y(41));
            ctx.lineTo(lon2x(26), lat2y(41));
            ctx.lineTo(lon2x(27), lat2y(42));
            ctx.lineTo(lon2x(28), lat2y(42));
            // Balkans
            ctx.lineTo(lon2x(26), lat2y(43));
            ctx.lineTo(lon2x(24), lat2y(44));
            ctx.lineTo(lon2x(22), lat2y(45));
            ctx.lineTo(lon2x(20), lat2y(45));
            ctx.lineTo(lon2x(18), lat2y(45));
            ctx.lineTo(lon2x(16), lat2y(46));
            // Italy
            ctx.lineTo(lon2x(15), lat2y(45));
            ctx.lineTo(lon2x(14), lat2y(44));
            ctx.lineTo(lon2x(13), lat2y(43));
            ctx.lineTo(lon2x(12), lat2y(42));
            ctx.lineTo(lon2x(12), lat2y(41));
            ctx.lineTo(lon2x(12), lat2y(40));
            ctx.lineTo(lon2x(13), lat2y(39));
            ctx.lineTo(lon2x(14), lat2y(38));
            ctx.lineTo(lon2x(15), lat2y(38));
            ctx.lineTo(lon2x(16), lat2y(39));
            ctx.lineTo(lon2x(17), lat2y(40));
            ctx.lineTo(lon2x(18), lat2y(41));
            ctx.lineTo(lon2x(17), lat2y(42));
            ctx.lineTo(lon2x(16), lat2y(43));
            ctx.lineTo(lon2x(14), lat2y(44));
            ctx.lineTo(lon2x(12), lat2y(45));
            ctx.lineTo(lon2x(10), lat2y(46));
            ctx.lineTo(lon2x(8), lat2y(46));
            ctx.lineTo(lon2x(7), lat2y(45));
            ctx.lineTo(lon2x(7), lat2y(44));
            ctx.lineTo(lon2x(8), lat2y(43));
            // Southern France
            ctx.lineTo(lon2x(6), lat2y(43));
            ctx.lineTo(lon2x(4), lat2y(43));
            ctx.lineTo(lon2x(2), lat2y(42));
            ctx.lineTo(lon2x(1), lat2y(42));
            ctx.lineTo(lon2x(0), lat2y(41));
            ctx.lineTo(lon2x(-1), lat2y(41));
            // Spain/Portugal
            ctx.lineTo(lon2x(-2), lat2y(40));
            ctx.lineTo(lon2x(-4), lat2y(39));
            ctx.lineTo(lon2x(-6), lat2y(38));
            ctx.lineTo(lon2x(-8), lat2y(37));
            ctx.lineTo(lon2x(-9), lat2y(37));
            ctx.lineTo(lon2x(-9), lat2y(38));
            ctx.lineTo(lon2x(-9), lat2y(40));
            ctx.lineTo(lon2x(-8), lat2y(42));
            ctx.lineTo(lon2x(-7), lat2y(43));
            ctx.lineTo(lon2x(-5), lat2y(44));
            // France west coast
            ctx.lineTo(lon2x(-4), lat2y(45));
            ctx.lineTo(lon2x(-3), lat2y(46));
            ctx.lineTo(lon2x(-2), lat2y(47));
            ctx.lineTo(lon2x(-1), lat2y(48));
            ctx.lineTo(lon2x(0), lat2y(49));
            ctx.lineTo(lon2x(1), lat2y(50));
            ctx.lineTo(lon2x(2), lat2y(51));
            ctx.lineTo(lon2x(3), lat2y(51));
            // North Europe
            ctx.lineTo(lon2x(4), lat2y(52));
            ctx.lineTo(lon2x(5), lat2y(53));
            ctx.lineTo(lon2x(6), lat2y(54));
            ctx.lineTo(lon2x(7), lat2y(55));
            ctx.lineTo(lon2x(8), lat2y(56));
            ctx.lineTo(lon2x(8), lat2y(57));
            ctx.lineTo(lon2x(7), lat2y(58));
            ctx.lineTo(lon2x(6), lat2y(59));
            ctx.lineTo(lon2x(5), lat2y(60));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Japan
            ctx.beginPath();
            // Hokkaido
            ctx.moveTo(lon2x(141), lat2y(45));
            ctx.lineTo(lon2x(142), lat2y(45));
            ctx.lineTo(lon2x(143), lat2y(44));
            ctx.lineTo(lon2x(145), lat2y(44));
            ctx.lineTo(lon2x(146), lat2y(43));
            ctx.lineTo(lon2x(145), lat2y(42));
            ctx.lineTo(lon2x(143), lat2y(42));
            ctx.lineTo(lon2x(141), lat2y(43));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Honshu
            ctx.beginPath();
            ctx.moveTo(lon2x(139), lat2y(41));
            ctx.lineTo(lon2x(140), lat2y(41));
            ctx.lineTo(lon2x(141), lat2y(40));
            ctx.lineTo(lon2x(141), lat2y(38));
            ctx.lineTo(lon2x(140), lat2y(36));
            ctx.lineTo(lon2x(139), lat2y(35));
            ctx.lineTo(lon2x(138), lat2y(34));
            ctx.lineTo(lon2x(137), lat2y(35));
            ctx.lineTo(lon2x(137), lat2y(36));
            ctx.lineTo(lon2x(138), lat2y(38));
            ctx.lineTo(lon2x(138), lat2y(40));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Kyushu
            ctx.beginPath();
            ctx.moveTo(lon2x(130), lat2y(34));
            ctx.lineTo(lon2x(131), lat2y(34));
            ctx.lineTo(lon2x(132), lat2y(33));
            ctx.lineTo(lon2x(131), lat2y(32));
            ctx.lineTo(lon2x(130), lat2y(31));
            ctx.lineTo(lon2x(129), lat2y(32));
            ctx.lineTo(lon2x(129), lat2y(33));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Philippines
            ctx.beginPath();
            // Luzon
            ctx.moveTo(lon2x(120), lat2y(19));
            ctx.lineTo(lon2x(121), lat2y(19));
            ctx.lineTo(lon2x(122), lat2y(18));
            ctx.lineTo(lon2x(122), lat2y(16));
            ctx.lineTo(lon2x(121), lat2y(15));
            ctx.lineTo(lon2x(120), lat2y(15));
            ctx.lineTo(lon2x(120), lat2y(17));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Mindanao
            ctx.beginPath();
            ctx.moveTo(lon2x(124), lat2y(9));
            ctx.lineTo(lon2x(126), lat2y(9));
            ctx.lineTo(lon2x(126), lat2y(7));
            ctx.lineTo(lon2x(125), lat2y(6));
            ctx.lineTo(lon2x(124), lat2y(6));
            ctx.lineTo(lon2x(124), lat2y(8));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Indonesia
            ctx.beginPath();
            // Sumatra
            ctx.moveTo(lon2x(95), lat2y(6));
            ctx.lineTo(lon2x(97), lat2y(6));
            ctx.lineTo(lon2x(100), lat2y(4));
            ctx.lineTo(lon2x(101), lat2y(2));
            ctx.lineTo(lon2x(101), lat2y(0));
            ctx.lineTo(lon2x(100), lat2y(-2));
            ctx.lineTo(lon2x(98), lat2y(-4));
            ctx.lineTo(lon2x(96), lat2y(-4));
            ctx.lineTo(lon2x(95), lat2y(-2));
            ctx.lineTo(lon2x(95), lat2y(0));
            ctx.lineTo(lon2x(95), lat2y(3));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Java
            ctx.beginPath();
            ctx.moveTo(lon2x(106), lat2y(-6));
            ctx.lineTo(lon2x(108), lat2y(-6));
            ctx.lineTo(lon2x(111), lat2y(-7));
            ctx.lineTo(lon2x(114), lat2y(-8));
            ctx.lineTo(lon2x(114), lat2y(-8.5));
            ctx.lineTo(lon2x(111), lat2y(-8.5));
            ctx.lineTo(lon2x(108), lat2y(-7.5));
            ctx.lineTo(lon2x(106), lat2y(-7));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Borneo
            ctx.beginPath();
            ctx.moveTo(lon2x(109), lat2y(7));
            ctx.lineTo(lon2x(112), lat2y(7));
            ctx.lineTo(lon2x(115), lat2y(5));
            ctx.lineTo(lon2x(118), lat2y(3));
            ctx.lineTo(lon2x(119), lat2y(0));
            ctx.lineTo(lon2x(119), lat2y(-3));
            ctx.lineTo(lon2x(117), lat2y(-4));
            ctx.lineTo(lon2x(115), lat2y(-4));
            ctx.lineTo(lon2x(112), lat2y(-3));
            ctx.lineTo(lon2x(110), lat2y(-1));
            ctx.lineTo(lon2x(109), lat2y(2));
            ctx.lineTo(lon2x(109), lat2y(5));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Africa - more accurate
            ctx.beginPath();
            // North Africa
            ctx.moveTo(lon2x(-17), lat2y(28));
            ctx.lineTo(lon2x(-15), lat2y(30));
            ctx.lineTo(lon2x(-13), lat2y(32));
            ctx.lineTo(lon2x(-10), lat2y(34));
            ctx.lineTo(lon2x(-6), lat2y(36));
            ctx.lineTo(lon2x(-2), lat2y(37));
            ctx.lineTo(lon2x(3), lat2y(37));
            ctx.lineTo(lon2x(8), lat2y(37));
            ctx.lineTo(lon2x(12), lat2y(36));
            ctx.lineTo(lon2x(16), lat2y(34));
            ctx.lineTo(lon2x(20), lat2y(33));
            ctx.lineTo(lon2x(24), lat2y(32));
            ctx.lineTo(lon2x(28), lat2y(32));
            ctx.lineTo(lon2x(32), lat2y(31));
            ctx.lineTo(lon2x(36), lat2y(30));
            // Red Sea - connecting to Eurasia through Sinai
            ctx.lineTo(lon2x(36), lat2y(29));
            ctx.lineTo(lon2x(34), lat2y(29));
            ctx.lineTo(lon2x(34), lat2y(31));
            ctx.lineTo(lon2x(35), lat2y(32));
            // Back down Red Sea
            ctx.lineTo(lon2x(38), lat2y(28));
            ctx.lineTo(lon2x(40), lat2y(26));
            ctx.lineTo(lon2x(42), lat2y(24));
            ctx.lineTo(lon2x(43), lat2y(22));
            ctx.lineTo(lon2x(44), lat2y(20));
            ctx.lineTo(lon2x(46), lat2y(18));
            ctx.lineTo(lon2x(48), lat2y(16));
            ctx.lineTo(lon2x(50), lat2y(14));
            // East Africa
            ctx.lineTo(lon2x(51), lat2y(12));
            ctx.lineTo(lon2x(51), lat2y(8));
            ctx.lineTo(lon2x(51), lat2y(4));
            ctx.lineTo(lon2x(51), lat2y(0));
            ctx.lineTo(lon2x(50), lat2y(-4));
            ctx.lineTo(lon2x(48), lat2y(-8));
            ctx.lineTo(lon2x(46), lat2y(-12));
            ctx.lineTo(lon2x(44), lat2y(-16));
            ctx.lineTo(lon2x(42), lat2y(-20));
            ctx.lineTo(lon2x(40), lat2y(-24));
            ctx.lineTo(lon2x(38), lat2y(-26));
            ctx.lineTo(lon2x(36), lat2y(-28));
            ctx.lineTo(lon2x(34), lat2y(-30));
            ctx.lineTo(lon2x(32), lat2y(-32));
            // South Africa
            ctx.lineTo(lon2x(30), lat2y(-33));
            ctx.lineTo(lon2x(28), lat2y(-34));
            ctx.lineTo(lon2x(26), lat2y(-34));
            ctx.lineTo(lon2x(24), lat2y(-34));
            ctx.lineTo(lon2x(22), lat2y(-34));
            ctx.lineTo(lon2x(20), lat2y(-33));
            ctx.lineTo(lon2x(18), lat2y(-32));
            ctx.lineTo(lon2x(16), lat2y(-30));
            ctx.lineTo(lon2x(14), lat2y(-28));
            // West Coast
            ctx.lineTo(lon2x(13), lat2y(-24));
            ctx.lineTo(lon2x(12), lat2y(-20));
            ctx.lineTo(lon2x(12), lat2y(-16));
            ctx.lineTo(lon2x(12), lat2y(-12));
            ctx.lineTo(lon2x(12), lat2y(-8));
            ctx.lineTo(lon2x(12), lat2y(-4));
            ctx.lineTo(lon2x(10), lat2y(0));
            ctx.lineTo(lon2x(8), lat2y(4));
            ctx.lineTo(lon2x(6), lat2y(8));
            ctx.lineTo(lon2x(4), lat2y(10));
            ctx.lineTo(lon2x(2), lat2y(11));
            ctx.lineTo(lon2x(0), lat2y(11));
            ctx.lineTo(lon2x(-2), lat2y(12));
            ctx.lineTo(lon2x(-4), lat2y(13));
            ctx.lineTo(lon2x(-6), lat2y(14));
            ctx.lineTo(lon2x(-8), lat2y(15));
            ctx.lineTo(lon2x(-10), lat2y(16));
            ctx.lineTo(lon2x(-12), lat2y(18));
            ctx.lineTo(lon2x(-14), lat2y(20));
            ctx.lineTo(lon2x(-16), lat2y(23));
            ctx.lineTo(lon2x(-17), lat2y(26));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Madagascar
            ctx.beginPath();
            ctx.moveTo(lon2x(43), lat2y(-12));
            ctx.lineTo(lon2x(44), lat2y(-12));
            ctx.lineTo(lon2x(51), lat2y(-15));
            ctx.lineTo(lon2x(51), lat2y(-20));
            ctx.lineTo(lon2x(48), lat2y(-25));
            ctx.lineTo(lon2x(45), lat2y(-26));
            ctx.lineTo(lon2x(44), lat2y(-24));
            ctx.lineTo(lon2x(43), lat2y(-20));
            ctx.lineTo(lon2x(43), lat2y(-15));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Australia - more accurate
            ctx.beginPath();
            // North coast
            ctx.moveTo(lon2x(113), lat2y(-10));
            ctx.lineTo(lon2x(118), lat2y(-11));
            ctx.lineTo(lon2x(123), lat2y(-12));
            ctx.lineTo(lon2x(128), lat2y(-12));
            ctx.lineTo(lon2x(133), lat2y(-11));
            ctx.lineTo(lon2x(138), lat2y(-12));
            ctx.lineTo(lon2x(142), lat2y(-11));
            // East coast
            ctx.lineTo(lon2x(145), lat2y(-13));
            ctx.lineTo(lon2x(148), lat2y(-15));
            ctx.lineTo(lon2x(150), lat2y(-18));
            ctx.lineTo(lon2x(151), lat2y(-22));
            ctx.lineTo(lon2x(153), lat2y(-26));
            ctx.lineTo(lon2x(153), lat2y(-30));
            ctx.lineTo(lon2x(152), lat2y(-34));
            // South coast
            ctx.lineTo(lon2x(150), lat2y(-36));
            ctx.lineTo(lon2x(148), lat2y(-38));
            ctx.lineTo(lon2x(145), lat2y(-38));
            ctx.lineTo(lon2x(140), lat2y(-37));
            ctx.lineTo(lon2x(136), lat2y(-35));
            ctx.lineTo(lon2x(132), lat2y(-34));
            ctx.lineTo(lon2x(128), lat2y(-34));
            ctx.lineTo(lon2x(124), lat2y(-34));
            ctx.lineTo(lon2x(120), lat2y(-33));
            ctx.lineTo(lon2x(116), lat2y(-32));
            // West coast
            ctx.lineTo(lon2x(114), lat2y(-28));
            ctx.lineTo(lon2x(113), lat2y(-24));
            ctx.lineTo(lon2x(113), lat2y(-20));
            ctx.lineTo(lon2x(113), lat2y(-15));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // New Zealand
            ctx.beginPath();
            // North Island
            ctx.moveTo(lon2x(174), lat2y(-35));
            ctx.lineTo(lon2x(175), lat2y(-35));
            ctx.lineTo(lon2x(178), lat2y(-37));
            ctx.lineTo(lon2x(178), lat2y(-39));
            ctx.lineTo(lon2x(176), lat2y(-40));
            ctx.lineTo(lon2x(174), lat2y(-39));
            ctx.lineTo(lon2x(174), lat2y(-37));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // South Island
            ctx.beginPath();
            ctx.moveTo(lon2x(170), lat2y(-41));
            ctx.lineTo(lon2x(172), lat2y(-40));
            ctx.lineTo(lon2x(174), lat2y(-41));
            ctx.lineTo(lon2x(174), lat2y(-43));
            ctx.lineTo(lon2x(172), lat2y(-45));
            ctx.lineTo(lon2x(170), lat2y(-46));
            ctx.lineTo(lon2x(168), lat2y(-46));
            ctx.lineTo(lon2x(167), lat2y(-44));
            ctx.lineTo(lon2x(168), lat2y(-42));
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        function drawAstroLines(ctx, width, height, planets) {
            const isMobile = window.innerWidth < 768;
            const symbolSize = isMobile ? 18 : 24;
            const circleRadius = isMobile ? 15 : 20;
            
            planets.forEach(planet => {
                const color = planetColors[planet];
                const planetLon = calculatedPlanetaryPositions[planet];
                const planetDeclination = getPlanetDeclination(planet);
                
                // Draw MC line (solid, vertical)
                drawMCLine(ctx, planetLon, color, width, height, planet, symbolSize, circleRadius, isMobile);
                
                // Draw IC line (dotted, vertical)
                drawICLine(ctx, planetLon, color, width, height, planet, symbolSize, circleRadius, isMobile);
                
                // Draw ASC line (dashed, curved)
                drawASCLine(ctx, planetLon, planetDeclination, color, width, height, planet, symbolSize, circleRadius, isMobile);
                
                // Draw DSC line (dash-dot, curved)
                drawDSCLine(ctx, planetLon, planetDeclination, color, width, height, planet, symbolSize, circleRadius, isMobile);
            });
            
            ctx.globalAlpha = 1;
            ctx.setLineDash([]);
        }
        
        function getPlanetDeclination(planet) {
            // Convert ecliptic longitude to approximate declination
            // This is simplified - real calculation requires full equatorial conversion
            const lon = calculatedPlanetaryPositions[planet];
            const eclipticObliquity = 23.4397; // degrees
            
            // Approximate declination using simplified formula
            const lonRad = lon * Math.PI / 180;
            const oblRad = eclipticObliquity * Math.PI / 180;
            
            const declination = Math.asin(Math.sin(oblRad) * Math.sin(lonRad)) * 180 / Math.PI;
            
            return declination;
        }
        
        function drawMCLine(ctx, planetLon, color, width, height, planet, symbolSize, circleRadius, isMobile) {
            const x = ((planetLon + 180) % 360) / 360 * width;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.8;
            ctx.setLineDash([]);
            
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
            
            // Add MC symbol at top
            ctx.globalAlpha = 1;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.beginPath();
            ctx.arc(x, 25, circleRadius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = color;
            ctx.font = 'bold ' + (symbolSize - 4) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(planetSymbols[planet], x, 20);
            ctx.font = 'bold 10px sans-serif';
            ctx.fillText('MC', x, 32);
        }
        
        function drawICLine(ctx, planetLon, color, width, height, planet, symbolSize, circleRadius, isMobile) {
            const x = (((planetLon + 180) % 360) + 180) % 360 / 360 * width;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.6;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
            
            // Add IC symbol at bottom
            ctx.globalAlpha = 1;
            ctx.setLineDash([]);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.beginPath();
            ctx.arc(x, height - 25, circleRadius, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = color;
            ctx.font = 'bold ' + (symbolSize - 4) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(planetSymbols[planet], x, height - 30);
            ctx.font = 'bold 10px sans-serif';
            ctx.fillText('IC', x, height - 18);
        }
        
        function drawASCLine(ctx, planetLon, declination, color, width, height, planet, symbolSize, circleRadius, isMobile) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.7;
            ctx.setLineDash([10, 5]);
            
            ctx.beginPath();
            
            // Draw curved ASC line
            let firstPoint = true;
            for (let lat = 85; lat >= -85; lat -= 2) {
                const ascLon = calculateASCLongitude(planetLon, declination, lat);
                if (ascLon !== null) {
                    const x = ((ascLon + 180) % 360) / 360 * width;
                    const y = ((90 - lat) / 180) * height;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            }
            ctx.stroke();
            
            // Add ASC symbol
            ctx.globalAlpha = 1;
            ctx.setLineDash([]);
            const midLat = 0; // Equator
            const midAscLon = calculateASCLongitude(planetLon, declination, midLat);
            if (midAscLon !== null) {
                const symbolX = ((midAscLon + 180) % 360) / 360 * width;
                const symbolY = height / 2;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                ctx.beginPath();
                ctx.arc(symbolX, symbolY, circleRadius - 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = color;
                ctx.font = 'bold ' + (symbolSize - 6) + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(planetSymbols[planet], symbolX, symbolY - 5);
                ctx.font = 'bold 9px sans-serif';
                ctx.fillText('ASC', symbolX, symbolY + 6);
            }
        }
        
        function drawDSCLine(ctx, planetLon, declination, color, width, height, planet, symbolSize, circleRadius, isMobile) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.7;
            ctx.setLineDash([10, 5, 2, 5]);
            
            ctx.beginPath();
            
            // Draw curved DSC line (opposite of ASC)
            let firstPoint = true;
            for (let lat = 85; lat >= -85; lat -= 2) {
                const dscLon = calculateDSCLongitude(planetLon, declination, lat);
                if (dscLon !== null) {
                    const x = ((dscLon + 180) % 360) / 360 * width;
                    const y = ((90 - lat) / 180) * height;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            }
            ctx.stroke();
            
            // Add DSC symbol
            ctx.globalAlpha = 1;
            ctx.setLineDash([]);
            const midLat = 0; // Equator
            const midDscLon = calculateDSCLongitude(planetLon, declination, midLat);
            if (midDscLon !== null) {
                const symbolX = ((midDscLon + 180) % 360) / 360 * width;
                const symbolY = height / 2;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                ctx.beginPath();
                ctx.arc(symbolX, symbolY, circleRadius - 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = color;
                ctx.font = 'bold ' + (symbolSize - 6) + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(planetSymbols[planet], symbolX, symbolY - 5);
                ctx.font = 'bold 9px sans-serif';
                ctx.fillText('DSC', symbolX, symbolY + 6);
            }
        }
        
        function calculateASCLongitude(planetLon, declination, latitude) {
            // Calculate where planet rises at given latitude
            // Uses spherical astronomy formulas
            
            const latRad = latitude * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            
            // Planet must be visible (declination and latitude compatible)
            const cosineTerm = -Math.tan(latRad) * Math.tan(decRad);
            
            if (cosineTerm < -1 || cosineTerm > 1) {
                return null; // Planet doesn't rise at this latitude
            }
            
            // Hour angle when planet rises
            const hourAngle = Math.acos(cosineTerm) * 180 / Math.PI;
            
            // Convert to longitude (simplified)
            const ramc = planetLon; // Right ascension approximation
            const ascLon = (ramc - hourAngle + 360) % 360;
            
            return ascLon;
        }
        
        function calculateDSCLongitude(planetLon, declination, latitude) {
            // Calculate where planet sets at given latitude
            // Opposite of ASC
            
            const latRad = latitude * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            
            const cosineTerm = -Math.tan(latRad) * Math.tan(decRad);
            
            if (cosineTerm < -1 || cosineTerm > 1) {
                return null;
            }
            
            const hourAngle = Math.acos(cosineTerm) * 180 / Math.PI;
            const ramc = planetLon;
            const dscLon = (ramc + hourAngle + 360) % 360;
            
            return dscLon;
        }
        
        function drawCityMarkers(ctx, width, height, cities) {
            const isMobile = window.innerWidth < 768;
            const markerSize = isMobile ? 6 : 8;
            const fontSize = isMobile ? 12 : 16;
            const ringSize = isMobile ? 10 : 14;
            
            cities.forEach(city => {
                const x = ((city.lon + 180) / 360) * width;
                const y = ((90 - city.lat) / 180) * height;
                
                // Draw larger marker with glow effect
                ctx.shadowColor = '#fff';
                ctx.shadowBlur = isMobile ? 5 : 10;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(x, y, markerSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Add pulse ring
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = isMobile ? 1 : 2;
                ctx.beginPath();
                ctx.arc(x, y, ringSize, 0, Math.PI * 2);
                ctx.stroke();
                
                // Draw city name with better visibility
                ctx.font = 'bold ' + fontSize + 'px sans-serif';
                const textWidth = ctx.measureText(city.name).width;
                
                const padding = isMobile ? 6 : 12;
                const boxHeight = isMobile ? 20 : 28;
                const xOffset = isMobile ? 12 : 18;
                const yOffset = isMobile ? -8 : -14;
                
                // Black background with more padding
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.fillRect(x + xOffset, y + yOffset, textWidth + padding, boxHeight);
                
                // White border around text box
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + xOffset, y + yOffset, textWidth + padding, boxHeight);
                
                // City name in white
                ctx.fillStyle = '#fff';
                ctx.fillText(city.name, x + xOffset + padding/2, y + (isMobile ? 4 : 5));
            });
        }
        
        function updateLegend(planets) {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            
            const lineTypes = [
                { name: 'MC (Overhead)', style: 'solid' },
                { name: 'IC (Underfoot)', style: 'dotted' },
                { name: 'ASC (Rising)', style: 'dashed' },
                { name: 'DSC (Setting)', style: 'dashdot' }
            ];
            
            planets.forEach(planet => {
                const item = document.createElement('div');
                item.style.marginBottom = '1rem';
                item.style.padding = '0.75rem';
                item.style.borderLeft = '3px solid ' + planetColors[planet];
                
                let html = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem;">${planetSymbols[planet]}</span>
                        <span style="font-weight: 500;">${planetNames[planet]}</span>
                    </div>
                `;
                
                lineTypes.forEach(type => {
                    let borderStyle = 'solid';
                    if (type.style === 'dotted') borderStyle = 'dotted';
                    else if (type.style === 'dashed') borderStyle = 'dashed';
                    else if (type.style === 'dashdot') borderStyle = 'dashed';
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 2rem; margin-bottom: 0.25rem;">
                            <div style="width: 30px; height: 2px; background: ${planetColors[planet]}; border-top: 2px ${borderStyle} ${planetColors[planet]};"></div>
                            <span style="font-size: 0.75rem; color: #999;">${type.name}</span>
                        </div>
                    `;
                });
                
                item.innerHTML = html;
                legend.appendChild(item);
            });
        }
        
        function showInterpretations(category, planets) {
            const interpretations = document.getElementById('interpretations');
            
            const meanings = {
                career: {
                    sun: 'Leadership, recognition, and authentic self-expression in your profession',
                    jupiter: 'Expansion, opportunity, and professional growth',
                    saturn: 'Structure, discipline, and lasting career achievements',
                    mars: 'Drive, ambition, and dynamic professional energy'
                },
                studies: {
                    mercury: 'Mental clarity, effective communication, and learning',
                    jupiter: 'Higher education, wisdom, and philosophical growth',
                    sun: 'Purposeful learning and intellectual development'
                },
                love: {
                    venus: 'Romance, harmony, and loving relationships',
                    moon: 'Emotional intimacy and nurturing connections'
                },
                family: {
                    moon: 'Emotional safety, nurturing, and family bonds',
                    venus: 'Domestic harmony and loving family relationships',
                    jupiter: 'Family growth, abundance, and joy'
                }
            };
            
            let html = '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #222;">';
            html += '<h3 style="font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; color: #999;">Understanding Your Lines</h3>';
            
            html += '<div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); font-size: 0.875rem; color: #999;">';
            html += '<p style="margin-bottom: 0.5rem;"><strong style="color: #fff;">MC (Midheaven)</strong> - Where the planet is directly overhead. Strongest for public/professional matters.</p>';
            html += '<p style="margin-bottom: 0.5rem;"><strong style="color: #fff;">IC (Imum Coeli)</strong> - Where the planet is underfoot. Strongest for private/home matters.</p>';
            html += '<p style="margin-bottom: 0.5rem;"><strong style="color: #fff;">ASC (Ascendant)</strong> - Where the planet rises. Affects your identity and how others see you.</p>';
            html += '<p><strong style="color: #fff;">DSC (Descendant)</strong> - Where the planet sets. Influences partnerships and relationships.</p>';
            html += '</div>';
            
            html += '<h3 style="font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; color: #999;">What Each Planet Brings</h3>';
            
            planets.forEach(planet => {
                if (meanings[category][planet]) {
                    html += '<div style="margin-bottom: 1rem; padding: 0.75rem; border-left: 2px solid ' + planetColors[planet] + ';">';
                    html += '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + planetNames[planet] + '</div>';
                    html += '<div style="font-size: 0.875rem; color: #999;">' + meanings[category][planet] + '</div>';
                    html += '</div>';
                }
            });
            
            html += '</div>';
            interpretations.innerHTML = html;
        }
        
        function showCityList(cities, category) {
            const cityList = document.getElementById('cityList');
            
            if (cities.length === 0) {
                cityList.innerHTML = '<p style="color: #999;">Calculating your strongest locations...</p>';
                return;
            }
            
            let html = '<h3 style="font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; color: #999;">Your Strongest Locations</h3>';
            html += '<p style="color: #999; font-size: 0.875rem; margin-bottom: 1rem;">These cities sit on your most powerful planetary lines for ' + category + '.</p>';
            
            cities.forEach(city => {
                const linesList = city.lines.map(line => {
                    const parts = line.split('_');
                    const planet = parts[0];
                    const lineType = parts[1].toUpperCase();
                    return `<span style="color: ${planetColors[planet]}">${planetNames[planet]} ${lineType}</span>`;
                }).join(', ');
                
                html += '<div class="city-item">';
                html += '<div>';
                html += '<div class="city-name">' + city.name + '</div>';
                html += '<div class="city-country">' + city.country + '</div>';
                html += '</div>';
                html += '<div class="city-lines" style="color: #999;">' + linesList + '</div>';
                html += '</div>';
            });
            
            cityList.innerHTML = html;
        }
        
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'map') {
                document.getElementById('mapView').style.display = 'block';
                document.getElementById('chartView').style.display = 'none';
                tabs[0].classList.add('active');
            } else {
                document.getElementById('mapView').style.display = 'none';
                document.getElementById('chartView').style.display = 'block';
                tabs[1].classList.add('active');
                drawNatalChart();
            }
        }
        
        function getZodiacSign(degree) {
            const normalizedDegree = degree % 360;
            for (let i = zodiacSigns.length - 1; i >= 0; i--) {
                if (normalizedDegree >= zodiacSigns[i].start) {
                    const degreeInSign = normalizedDegree - zodiacSigns[i].start;
                    return {
                        sign: zodiacSigns[i],
                        degree: Math.floor(degreeInSign),
                        minute: Math.floor((degreeInSign % 1) * 60)
                    };
                }
            }
            return {
                sign: zodiacSigns[0],
                degree: Math.floor(normalizedDegree),
                minute: Math.floor((normalizedDegree % 1) * 60)
            };
        }
        
        function drawNatalChart() {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 200;
            
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw outer circle
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // Draw zodiac wheel (12 signs)
            ctx.lineWidth = 1;
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180; // Start from Aries at top
                
                // Draw division lines
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + Math.cos(angle) * radius,
                    centerY + Math.sin(angle) * radius
                );
                ctx.strokeStyle = '#333';
                ctx.stroke();
                
                // Draw zodiac symbols
                const symbolAngle = (i * 30 + 15 - 90) * Math.PI / 180;
                const symbolRadius = radius - 30;
                const symbolX = centerX + Math.cos(symbolAngle) * symbolRadius;
                const symbolY = centerY + Math.sin(symbolAngle) * symbolRadius;
                
                ctx.fillStyle = '#666';
                ctx.font = '24px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(zodiacSigns[i].symbol, symbolX, symbolY);
            }
            
            // Draw inner circle for houses
            const innerRadius = radius - 60;
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2);
            ctx.stroke();
            
            // Draw planets
            const planetsToShow = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'asc'];
            
            planetsToShow.forEach(planet => {
                const position = calculatedPlanetaryPositions[planet];
                if (position === undefined) return;
                
                const angle = (position - 90) * Math.PI / 180; // Adjust to start from top
                const planetRadius = innerRadius - 30;
                const planetX = centerX + Math.cos(angle) * planetRadius;
                const planetY = centerY + Math.sin(angle) * planetRadius;
                
                // Draw planet symbol
                ctx.fillStyle = planetColors[planet];
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(planetSymbols[planet], planetX, planetY);
                
                // Draw line from center to planet
                ctx.strokeStyle = planetColors[planet];
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(planetX, planetY);
                ctx.stroke();
                ctx.globalAlpha = 1;
            });
            
            // Draw ascendant line (thicker)
            if (calculatedPlanetaryPositions.asc !== undefined) {
                const ascAngle = (calculatedPlanetaryPositions.asc - 90) * Math.PI / 180;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + Math.cos(ascAngle) * radius,
                    centerY + Math.sin(ascAngle) * radius
                );
                ctx.stroke();
            }
            
            // Update planet positions list
            updatePlanetPositions();
        }
        
        function updatePlanetPositions() {
            const container = document.getElementById('planetPositions');
            container.innerHTML = '';
            
            const planetsToShow = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'asc', 'mc'];
            
            planetsToShow.forEach(planet => {
                const position = calculatedPlanetaryPositions[planet];
                if (position === undefined) return;
                
                const zodiac = getZodiacSign(position);
                
                const div = document.createElement('div');
                div.className = 'planet-position';
                div.style.borderLeftColor = planetColors[planet];
                div.style.borderLeftWidth = '3px';
                
                div.innerHTML = `
                    <div class="planet-details">
                        <span class="planet-symbol" style="color: ${planetColors[planet]}">${planetSymbols[planet]}</span>
                        <span style="font-weight: 500;">${planetNames[planet]}</span>
                    </div>
                    <div>
                        <span class="planet-sign">${zodiac.sign.name} ${zodiac.sign.symbol}</span>
                        <span class="planet-degree">${zodiac.degree}°${zodiac.minute}'</span>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
